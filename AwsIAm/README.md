# 安全なIAMの設計を理解する

## 課題1

前提：
IAMとは、AWSの認証とアクセス制御を管理するサービス。
IAMを使用すれば、誰がどのサービスにアクセスできるのかを、許可または拒否することができる。

https://www.softbank.jp/biz/blog/cloud-technology/articles/202212/aws-iam/

- IAMユーザ（認証）

AWSで作成したエンティティ（ユーザやアプリケーション）のこと。AWSにアクセスするための認証情報やアクセス権限を持つ。
AWSアカウントの中に複数作ることができ、1エンティティごとに個別のIAMユーザーを作成することが推奨されている。

- IAMグループ

IAMユーザーの集合体。グループを使用すると、複数のユーザに対してアクセス許可を指定でき、それらのユーザのアクセス許可を容易に管理することができる。
たとえば、Admins というユーザーグループを作成し、管理者が一般的に必要とするようなアクセス許可をそのユーザーグループに付与できる。

- IAMポリシー（認可）

「何に対して」「どのような操作を」「できるか（できないか）」といったAWSリソースへの操作権限を設定する機能。
IAM アイデンティティ (ユーザー、ユーザーのグループ、ロール) または AWS リソースに紐付けることができる。
アイデンティティベースのポリシー、リソースベースのポリシー、アクセス許可の境界、 SCP、ACL とセッションポリシーの計 6 種類のポリシーがある。

- IAMロール

ロールは複数のポリシーによって構成される。IAMユーザは 1 人の特定の人に一意に関連付けられるが、ロールはそれを必要とする任意の人が引き受けるようになっている。
また、ロールには標準の認証情報も関連付けられない。代わりに、ロールを引き受けると、ロールセッション用の一時的なセキュリティ認証情報が提供される。
ロールを使用して、通常は AWSリソースへのアクセス権のないユーザー、アプリケーション、サービスにそのアクセス権を一時的に委任できる。

- Permission boundary（アクセス許可境界）

IAMユーザまたはIAMロールに対して、通常のポリシーに追加して付与するポリシーのひとつ。
Permissions Boundaryが付与された場合、権限はポリシーとPermission boundaryの積となる。
実際には両方で許可されていれば許可となり、どちらかで拒否されていれば拒否となる。
これをうまく使うことで、権限昇格を防止した上で利用者にIAMの権限を移譲することができる。
例えば、利用者のアカウント内ではサービスに必要なロールは管理者に申請せずに自分で作成して欲しいが、
利用者に与えられている権限や禁止したい操作を超えたロールを使わせたくない場合に使える。

- AWS管理ポリシー
  あらかじめAWSによって用意されている管理ポリシー。大まかに各AWSサービスごとにフル権限と読み取り権限が用意されている。

- カスタマー管理ポリシー
  利用者が独自に作成する管理ポリシー。細かい権限付与が可能。

- ホワイトリストパターン、ブラックリストパターン
  IAMポリシーを設計するにあたってのデザインパターン。
  ホワイトリストは、明示的許可のみを行うパターン。許可を記述していないアクションについては暗黙的に拒否される。
  ブラックリストは、明示的拒否のみを行うパターン。該当するアクションの権限は他のポリシーにより上書きすることができない。またこのポリシーだけでは何の権限も与えない。


## 課題2

### ユーザー

#### 質問：なぜルートでなく管理者権限

- すべてのリソースに対して無制限なアクセスが可能なため、共有のミスなので漏洩した場合の被害が大きい
- さらに適切な権限の管理は、AWSとしてお客様の責任に分類させるためAWS側は責任を負わない

参考
https://dev.classmethod.jp/articles/rootuser-risk/

https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/root-user-best-practices.html


#### 質問：ひとつのIAMユーザを使い回す問題

- 権限を分けたいときに適切に分けることができない
- 何かあった時に誰が何を操作したのかを追うことができない
- パスワードの変更などがあった際に共有が必要でありリスクが高い

#### PowerUserエラーメッセージ

- 「アクセス拒否」iam:〇〇 に対する許可がありません〜
- PowerUserAccessはAdministratorAccessと異なり、IAMの操作を行うことができない

#### AWS管理ポリシーとカスタマー管理ポリシーの使い分け

- 一般的なユースケースには管理ポリシーを使用し、特定のユースケースにはよりアクセス許可を制限できるカスタマー管理ポリシーを使う。

https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/best-practices.html#bp-use-aws-defined-policies

### グループ

#### 直接ポリシー付与とグループのどちらが適切か？

グループの方が適切。
ユーザー数が少ない場合は管理できるが、ユーザーが増える場合に個人ごとだと権限管理が複雑になってしまい、誤るリスクが増えてしまう。

### サービスのIAM

ssh -i "../.ssh/test-ec2-key.pem" ec2-user@ec2-52-198-181-94.ap-northeast-1.compute.amazonaws.com

aws s3 ls s3://sakurai-test-s3-to-ec2

[ec2-user@ip-172-31-45-249 ~]$ aws s3 ls s3://sakurai-test-s3-to-ec2
                           PRE test/
[ec2-user@ip-172-31-45-249 ~]$ aws s3 ls s3://sakurai-test2-s3-to-ec2

An error occurred (AccessDenied) when calling the ListObjectsV2 operation: Access Denied

#### EC2にロールを付与すべきかポリシーを付与すべきか？

- ポリシーを付与するのが適切
- ロールであれば複数のポリシーを適用できるので、一括で管理しやすい

#### 「Resource based」と「Identity based」

- Resource based
S3、EC2などのリソースにアタッチされ、アクセス許可を指定できる
リソース自体に対するアクセス権を制御する

- Identity based
IAMユーザー、グループ、ロールにアタッチされ、アクセス許可を指定できる
エンティティができる操作を制御する

許可をしたい場合はIdentity based
拒否をしたい場合はResource based

#### S3の制御

- S3バケットポリシー
- バケットのパブリックアクセス設定
- アクセス制御リスト (ACL)

### 設計

#### ホワイトリストとブラックリスト

- ホワイトリスト

最小限の許可のみ与えれば不要なアクセスを防げる
許可が明確のためわかりやすい
ユーザやリソースが増えると管理が煩雑になる

- ブラックリスト

拒否だけ設定しておけばいいので管理が楽
柔軟性が高く正常なアクセスを妨げない
リストに追加しないと拒否できないため、新しくリソースが増えた場合に手間になる

- 例

AWSのセキュリティグループ: ホワイトリスト
AWS WAF: ブラックリスト(ホワイトリストもできる)

PostgreSQLのRLSはホワイトリスト


### ルールが守られているかチェックしてくれるサービスは？

AWS Config
さらにAWS System Managerを使うと、ルールに準拠していない場合に自動修復できる

## 課題3(クイズ)

1. AssumeRoleとはなんでしょうか？

A. あるIAMエンティティ（ユーザー、アプリケーション、またはサービス）が一時的に別のロールを引き受けることを可能にする機能

2. ユーザーのアクティビティを追跡できるサービスはなんでしょうか？

A. Cloud Trail

3. IAM Access Analyzerとはどんなサービスでしょうか？

AWSリソースのポリシーを確認して、意図せぬ公開設定などがされていないか検出し、可視化する機能