# DBモデリング2

[課題1](./課題1.svg)

## 課題1-fix

dbdiagramを使って作り直す。

[課題1-fix](https://dbdiagram.io/d/61988f4a02cf5d186b5f8c53)

### テーブル構成概要

|テーブル名|説明|
|:--|:--|
|ユーザー|ユーザーマスタ|
|参加ワークスペース|参加しているワークスペースの管理|
|ワークスペース|ワークスペースの管理|
|参加チャネル|参加しているチャネルの管理|
|チャネル|チャネルの管理|
|メッセージ|メッセージとスレッドメッセージの管理|

### テーブル構成概要-fix
|テーブル名|説明|
|:--|:--|
|ユーザー|ユーザーマスタ|
|参加ワークスペース|参加しているワークスペースの管理|
|ワークスペース|ワークスペースの管理|
|参加チャネル|参加しているチャネルの管理|
|チャネル|チャネルの管理|
|メッセージ|メッセージの管理|
|スレッドメッセージ|スレッドメッセージの管理|
|スレッド|スレッドの管理|

### 要望

[要望内容](https://airtable.com/appPxhCPFYGqqN9YU/tblVlFr2q4lIqDKYc/viwX8r6DpCRp80swL/recQw47AKhRTQsfgI?blocks=hide)

### 要望への対応

1. メッセージ

- チャネルIDを持たせることで「どのチャネルに」を特定できる
- ユーザーIDを持たせることで「誰が」を特定できる
- 本文と作成日時で、「いつ、どんな内容を」を特定できる

2. スレッドメッセージ

- 親メッセージIDを持つメッセージは「スレッドメッセージ」とする
- 親メッセージIDを見ることで「どのメッセージに」を特定できる
- メッセージテーブルで実現するため、「誰が、いつ、どんな内容を」が特定できる

3. チャネル

- 参加チャネルテーブルを見ることで「ユーザーがどのチャネルに属しているか」を特定できる
- そのため、参加していないチャネルを見られないようにすることができる
- 参加チャネルは、ユーザーの参加ワークスペースからのみ選べるようにする

4. ユーザー

- 「参加時」に、参加ワークスペース/参加チャネルにデータを作り、「脱退時」に消す
- データが消えることで、特定のワークスペース/チャネルを辿れないようになる
- 参加ワークスペースから脱退すると、紐づくチャネルからも脱退する

5. 横断機能

- 検索文字列を「メッセージテーブル」からLIKE検索をする
- 参加チャネルから紐づくメッセージのみを検索できる（参加していないチャネルからは検索不可）

```例
SELECT 
 メッセージ
FROM 参加チャネル
INNER JOIN チャネル
INNER JOIN メッセージ
WHERE 参加チャネル.ユーザーID = 検索.ユーザーID (参加チャネルのみから検索)
AND メッセージ.本文 LIKE 検索.本文（スレッドメッセージも検索可能)
```

### 懸念点
- メッセージが膨大な量になる（スレッドも同じため）
- ユーザーとワークスペースとチャネルのリレーションが怪しい

### 参考資料
- https://api.slack.com/messaging/managing